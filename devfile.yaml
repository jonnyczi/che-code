#
# Copyright (c) 2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#

schemaVersion: 2.1.0
metadata:
  name: che-code
components:

  # - name: dev
  #   container:
  #     image: quay.io/che-incubator/che-code-dev:insiders
  #     memoryLimit: 7Gi
  #     cpuLimit: 3500m
  #     endpoints:
  #       - exposure: public
  #         name: dev
  #         secure: true
  #         protocol: http
  #         targetPort: 8000
  # - name: projects
  #   volume:
  #     size: 3Gi

  - name: dev
    container:
      # image: quay.io/devfile/universal-developer-image:ubi8-latest
      image: quay.io/vgulyy/universal-developer-image:ubi8-latest-1
      # env:
      #   - name: QUARKUS_HTTP_HOST
      #     value: 0.0.0.0
      # endpoints:
      #   - exposure: none
      #     name: debug
      #     protocol: tcp
      #     targetPort: 5005
      #   - exposure: public
      #     name: list-all-food
      #     protocol: http
      #     targetPort: 8080
      #     path: /food
      # volumeMounts:
      #   - name: m2
      #     path: /home/user/.m2
      memoryLimit: 12G
      memoryRequest: 512Mi
      cpuRequest: 500m
      cpuLimit: 1000m
      mountSources: true

commands:
  # - id: prepare
  #   exec:
  #     component: dev
  #     workingDir: ${PROJECTS_ROOT}/che-code
  #     commandLine: |
  #       yarn prepare
  #     group:
  #       kind: build

  # - id: build
  #   exec:
  #     component: dev
  #     workingDir: ${PROJECTS_ROOT}/che-code
  #     commandLine: |
  #       yarn watch
  #     group:
  #       kind: build
  #       isDefault: true

  # - id: run
  #   exec:
  #     component: dev
  #     workingDir: ${PROJECTS_ROOT}/che-code
  #     commandLine: |
  #       yarn server
  #     group:
  #       kind: run
  #       isDefault: true

  - id: run
    exec:
      component: dev
      workingDir: ${PROJECTS_ROOT}/che-code
      commandLine: |
        echo "Current dir >"
        pwd
      group:
        kind: run
        isDefault: true

  - id: prepade-node-16
    exec:
      component: dev
      workingDir: ${PROJECTS_ROOT}/che-code
      commandLine: |
        nvm install 16.17
        nvm use 16.17
        npm install yarn
      group:
        kind: build
        isDefault: true

  - id: compile-libc
    exec:
      component: dev
      workingDir: ${PROJECTS_ROOT}/che-code
      commandLine: |
        echo "Compile libc mod"
        cp -f build/dockerfiles/linux-libc.Dockerfile build/dockerfiles/linux-libc.no-test.Dockerfile
        REMOVE_FROM="### Testing"
        REMOVE_TO="# Store the content of the result"
        sed -i "/${REMOVE_FROM}/,/${REMOVE_TO}/{/${REMOVE_FROM}/n;/${REMOVE_TO}/!d;}" build/dockerfiles/linux-libc.no-test.Dockerfile
        podman build -f build/dockerfiles/linux-libc.no-test.Dockerfile -t linux-libc-amd64 .
      group:
        kind: run
        isDefault: true

  - id: build-che-code-image
    exec:
      component: dev
      workingDir: ${PROJECTS_ROOT}/che-code
      commandLine: |
        echo "Build che-code image"
        cp -f build/dockerfiles/assembly.Dockerfile build/dockerfiles/assembly.copy.Dockerfile

        REPLACE="FROM linux-musl-amd64 as linux-musl-content"
        sed -i -r -e "s|${REPLACE}||" build/dockerfiles/assembly.copy.Dockerfile

        REPLACE="COPY --from=linux-musl-content --chown=0:0 /checode-linux-musl /mnt/rootfs/checode-linux-musl"
        sed -i -r -e "s|${REPLACE}||" build/dockerfiles/assembly.copy.Dockerfile

        export DOCKER_BUILDKIT=1
        podman build -f build/dockerfiles/assembly.copy.Dockerfile -t che-code .

        docker tag che-code:latest che-code:next
        docker save -o /tmp/che-code-latest.tar che-code:latest che-code:next
      group:
        kind: run
        isDefault: true

